# =============================================================================
# Demo Expiration Workflow - MerchMasters
# =============================================================================
# Purpose: Automatically archive and make repository private after expiration
# Author: SE Community
# Expires: 2026-04-10
#
# This workflow runs daily and checks if the demo has expired. After expiration:
# 1. Adds deprecation notice to README
# 2. Archives the repository
# 3. Makes repository private (requires admin token)
# =============================================================================

name: Demo Expiration Check

on:
  schedule:
    # Run daily at midnight UTC
    - cron: '0 0 * * *'
  workflow_dispatch:
    # Allow manual trigger for testing

env:
  EXPIRATION_DATE: '2026-04-10'

jobs:
  check-expiration:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Check if demo has expired
        id: check
        run: |
          CURRENT_DATE=$(date +%Y-%m-%d)
          EXPIRATION="${{ env.EXPIRATION_DATE }}"

          echo "Current date: $CURRENT_DATE"
          echo "Expiration date: $EXPIRATION"

          if [[ "$CURRENT_DATE" > "$EXPIRATION" ]]; then
            echo "expired=true" >> $GITHUB_OUTPUT
            echo "::warning::Demo has EXPIRED as of $EXPIRATION"
          else
            echo "expired=false" >> $GITHUB_OUTPUT
            echo "Demo is still active until $EXPIRATION"
          fi

      - name: Add deprecation notice to README
        if: steps.check.outputs.expired == 'true'
        run: |
          # Check if deprecation notice already exists
          if ! grep -q "DEPRECATED" README.md; then
            # Create deprecation banner
            NOTICE="
          > ## ⚠️ DEPRECATED - THIS DEMO HAS EXPIRED
          >
          > **Expiration Date:** ${{ env.EXPIRATION_DATE }}
          >
          > This demonstration project has passed its expiration date. The code may contain
          > outdated Snowflake syntax or deprecated features. Please contact the SE team
          > for an updated version.
          >
          > ---

          "
            # Prepend notice to README
            echo "$NOTICE" | cat - README.md > temp && mv temp README.md

            # Commit the change
            git config user.name "github-actions[bot]"
            git config user.email "github-actions[bot]@users.noreply.github.com"
            git add README.md
            git commit -m "docs: Add deprecation notice - demo expired ${{ env.EXPIRATION_DATE }}"
            git push
          fi

      - name: Archive repository
        if: steps.check.outputs.expired == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.repos.update({
              owner: context.repo.owner,
              repo: context.repo.repo,
              archived: true
            });
            console.log('Repository has been archived');

      # Note: Making repository private requires admin token with repo scope
      # Uncomment the following step if you have appropriate permissions
      # - name: Make repository private
      #   if: steps.check.outputs.expired == 'true'
      #   uses: actions/github-script@v7
      #   with:
      #     github-token: ${{ secrets.ADMIN_TOKEN }}
      #     script: |
      #       await github.rest.repos.update({
      #         owner: context.repo.owner,
      #         repo: context.repo.repo,
      #         private: true
      #       });
      #       console.log('Repository has been made private');
