# Demo Expiration Workflow
# Author: SE Community
# Purpose: Automatically archive and make private after expiration date
# Expiration Date: 2025-12-31

name: Demo Expiration Check

on:
  schedule:
    # Run daily at midnight UTC
    - cron: '0 0 * * *'
  workflow_dispatch:
    # Allow manual trigger

env:
  EXPIRATION_DATE: '2025-12-31'

jobs:
  check-expiration:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      
    steps:
      - name: Check if demo has expired
        id: check
        run: |
          EXPIRATION=$(date -d "${{ env.EXPIRATION_DATE }}" +%s)
          TODAY=$(date +%s)
          
          if [ $TODAY -ge $EXPIRATION ]; then
            echo "expired=true" >> $GITHUB_OUTPUT
            echo "Demo has expired as of ${{ env.EXPIRATION_DATE }}"
          else
            echo "expired=false" >> $GITHUB_OUTPUT
            DAYS_LEFT=$(( ($EXPIRATION - $TODAY) / 86400 ))
            echo "Demo expires in $DAYS_LEFT days"
          fi
          
      - name: Archive repository (on expiration)
        if: steps.check.outputs.expired == 'true'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            // Archive the repository
            await github.rest.repos.update({
              owner: context.repo.owner,
              repo: context.repo.repo,
              archived: true
            });
            
            console.log('Repository archived due to expiration');
            
      - name: Add expiration notice to README
        if: steps.check.outputs.expired == 'true'
        run: |
          echo "## EXPIRED" > EXPIRED_NOTICE.md
          echo "" >> EXPIRED_NOTICE.md
          echo "This demonstration project expired on ${{ env.EXPIRATION_DATE }}." >> EXPIRED_NOTICE.md
          echo "" >> EXPIRED_NOTICE.md
          echo "The code may contain outdated Snowflake syntax or deprecated features." >> EXPIRED_NOTICE.md
          echo "" >> EXPIRED_NOTICE.md
          echo "For current examples, please refer to:" >> EXPIRED_NOTICE.md
          echo "- [Snowflake Documentation](https://docs.snowflake.com)" >> EXPIRED_NOTICE.md
          echo "- [Snowflake Quickstarts](https://quickstarts.snowflake.com)" >> EXPIRED_NOTICE.md

